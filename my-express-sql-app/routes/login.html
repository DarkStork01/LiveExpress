<script>
    app.post('/login', (req, res) => {
      let { email, username, password } = req.body;
    
      identifier = sanitizeInput(username || email);
      password = sanitizeInput(password);
    
      const findUserQuery = 'SELECT * FROM users WHERE username = ? OR email = ?';
    
      db.query(findUserQuery, [ identifier, identifier], async (err, results) => {
    
        if (err) {
          console.error('Error retrieving user:', err);
          return res.render('login', { error: 'Database error.' });
        }
    
        // If results array is empty, it means credentials are invalid
        if (results.length === 0) {
          return res.render('login', { error: 'Invalid username/email or password.' });
        }
      
        const user = results[0];
        const isPasswordValid = await bcrypt.compare(password, user.password); // Compare password
      
        if (!isPasswordValid) {
          return res.render("login", { error: "Invalid username/email or password." });
        }
          
    
        // Generate JWT token
        const token = generateToken(user);
          
        res.cookie("token", token, {
          httpOnly: true, // Prevents JavaScript from accessing the cookie
          secure: false,  // Set `true` if using HTTPS
          maxAge: 3600000, // 1 hour
        });
        // Otherwise, login is successful
        console.log(`User logged in: ${username}`);
        // Redirect them to a "dashboard" page
        res.redirect('/dashboard');
        logEvent('Login', `User logged in: ${username}`);
      });
    });
</script>